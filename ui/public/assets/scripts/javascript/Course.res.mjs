// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Auth from "./Auth.res.mjs";
import * as Meta from "./Meta.res.mjs";
import * as Browser from "./Browser.res.mjs";
import * as Core__Option from "@rescript/core/src/Core__Option.res.mjs";
import * as Caml_js_exceptions from "rescript/lib/es6/caml_js_exceptions.js";

function make_header_row() {
  var header_row = Browser.makeElement("tr");
  var checkbox_header = Browser.makeElement("th");
  checkbox_header.id = "checkbox_header";
  var select_all_checkbox = Browser.makeElement("input");
  select_all_checkbox.type = "checkbox";
  select_all_checkbox.id = "select_all_checkbox";
  checkbox_header.appendChild(select_all_checkbox);
  header_row.appendChild(checkbox_header);
  var course_name_header = Browser.makeElement("th");
  course_name_header.id = "course_name_header";
  course_name_header.innerText = "Nome";
  header_row.appendChild(course_name_header);
  var edit_header = Browser.makeElement("th");
  edit_header.id = "edit_header";
  edit_header.innerText = "Editar";
  header_row.appendChild(edit_header);
  return header_row;
}

function make_listing_table() {
  var div = Browser.makeElement("div");
  var header = Browser.makeElement("h2");
  header.innerText = "Cursos";
  div.appendChild(header);
  var table = Browser.makeElement("table");
  table.id = "course_table";
  var header_row = make_header_row();
  table.appendChild(header_row);
  div.appendChild(table);
  var delete_button = Browser.makeElement("button");
  delete_button.id = "delete_button";
  delete_button.innerText = "Excluir selecionados";
  div.appendChild(delete_button);
  return div;
}

function reset_table() {
  var table = Browser.getElement("course_table", "Course.reset_table");
  Browser.clearChildren(table);
  var header_row = make_header_row();
  table.appendChild(header_row);
}

async function update_table() {
  var table = Browser.getElement("course_table", "Course.update_table");
  var token = Auth.getCredentials().token;
  var response_store = {};
  var get_options = {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    }
  };
  reset_table();
  var response = await globalThis.fetch(Meta.endpoints.course, get_options);
  response_store.response = await response.clone();
  response_store.array = await response.json();
  var a = response_store.array;
  var array = a !== undefined ? a : [];
  array.forEach(function (course) {
        var row = Browser.makeElement("tr");
        var checkbox_cell = Browser.makeElement("td");
        var checkbox = Browser.makeElement("input");
        checkbox.type = "checkbox";
        checkbox.id = "course_" + course.id + "_checkbox";
        checkbox.class = "course_checkbox";
        checkbox_cell.appendChild(checkbox);
        row.appendChild(checkbox_cell);
        var name_cell = Browser.makeElement("td");
        name_cell.innerText = course.name;
        row.appendChild(name_cell);
        var edit_cell = Browser.makeElement("td");
        var edit_button = Browser.makeElement("button");
        edit_button.innerText = "Editar";
        edit_button.id = "course_" + course.id + "_edit_button";
        edit_button.class = "course_edit_button";
        edit_cell.appendChild(edit_button);
        row.appendChild(edit_cell);
        table.appendChild(row);
      });
}

function make_creation_form() {
  var div = Browser.makeElement("div");
  var fields = [{
      id: "name",
      kind: "text",
      label: "Nome:"
    }];
  var header = Browser.makeElement("h2");
  header.innerText = "Novo curso";
  div.appendChild(header);
  var form = Browser.FormBuilder.make_form(fields, "course_creation_form");
  div.appendChild(form);
  return div;
}

async function creation_handler($$event) {
  $$event.preventDefault();
  var dialog = Browser.getElement("user_dialog", "Course.creation_handler.dialog");
  var form = Browser.getElement("course_creation_form", "Course.creation_handler.form");
  dialog.innerText = "";
  var form_data = Object.fromEntries(new FormData(form));
  var token = Auth.getCredentials().token;
  var post_options = {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify(form_data)
  };
  var response_store = {};
  try {
    var response = await globalThis.fetch(Meta.endpoints.course, post_options);
    response_store.response = await response.clone();
  }
  catch (raw_error){
    var error = Caml_js_exceptions.internalToOCamlException(raw_error);
    console.log(error);
    dialog.innerText = "Erro na requisição";
  }
  try {
    var response$1 = response_store.response;
    var response$2 = response$1 !== undefined ? response$1 : ({
          __client_error: "[Course.creation_handler] No response in response_store"
        });
    var status = Core__Option.getExn(response$2.status, "[Course.creation_handler.status] Destructuring error");
    var exit = 0;
    if (status > 403 || status < 400) {
      if (status === 201 || status === 200) {
        dialog.innerText = "Curso criado com sucesso";
        await update_table();
        return ;
      }
      exit = 1;
    } else {
      if (status < 401) {
        dialog.innerText = "Requisição inválida. Os dados informados estão corretos?";
        return ;
      }
      switch (status) {
        case 401 :
            dialog.innerText = "Sua conta não possui acesso a esse recurso";
            return ;
        case 402 :
            exit = 1;
            break;
        case 403 :
            dialog.innerText = "Requisição inválida. Os dados informados estão corretos?";
            return ;
        
      }
    }
    if (exit === 1) {
      console.log("Unexpected return status " + status.toString());
      return ;
    }
    
  }
  catch (raw_error$1){
    var error$1 = Caml_js_exceptions.internalToOCamlException(raw_error$1);
    console.log(error$1);
    dialog.innerText = "Erro ao processar resposta";
    return ;
  }
}

async function structure() {
  var credentials = Auth.getCredentialsOption();
  var dialog = Browser.getElement("user_dialog", "Course.structure");
  if (!Core__Option.isSome(credentials)) {
    dialog.innerText = "Crie uma conta ou faça login primeiro";
    return ;
  }
  var table = make_listing_table();
  var form = make_creation_form();
  Browser.submitListen(form, creation_handler);
  var main = Browser.getElementByTag("main", "Course.structure.main");
  Browser.clearChildren(main);
  main.appendChild(table);
  main.appendChild(form);
  await update_table();
}

export {
  make_header_row ,
  make_listing_table ,
  reset_table ,
  update_table ,
  make_creation_form ,
  creation_handler ,
  structure ,
}
/* No side effect */
