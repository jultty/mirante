// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Meta from "./Meta.res.mjs";
import * as Browser from "./Browser.res.mjs";
import * as FormBuilder from "./FormBuilder.res.mjs";
import * as Core__Option from "@rescript/core/src/Core__Option.res.mjs";
import * as Caml_js_exceptions from "rescript/lib/es6/caml_js_exceptions.js";

async function populate_form() {
  var main = Browser.getElementByTag("main", "Login.main");
  Browser.clearChildren(main);
  var fields = [
    {
      id: "email",
      type: "email",
      label: "Email:"
    },
    {
      id: "password",
      type: "password",
      label: "Senha:"
    }
  ];
  var header = Browser.makeElement("h2");
  header.innerText = "Login";
  main.appendChild(header);
  var login_form = await FormBuilder.make_form(fields, "login_form");
  main.appendChild(login_form);
}

async function login_handler($$event) {
  $$event.preventDefault();
  var dialog = Browser.getElement("user_dialog", "Login.dialog");
  var login_form = Browser.getElement("login_form", "Login.login_form");
  dialog.innerText = "";
  var form_data = Object.fromEntries(new FormData(login_form));
  var post_options = {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(form_data)
  };
  var response_store = {};
  try {
    var response = await globalThis.fetch(Meta.schema.system.endpoints.login, post_options);
    response_store.response = await response.clone();
    response_store.json = await response.json();
  }
  catch (raw_error){
    var error = Caml_js_exceptions.internalToOCamlException(raw_error);
    console.log(error);
    dialog.innerText = "Erro na requisição";
  }
  try {
    var response$1 = response_store.response;
    var response$2 = response$1 !== undefined ? response$1 : ({
          __client_error: ""
        });
    var status = Core__Option.getExn(response$2.status, "[Login.status] Destructuring error");
    var exit = 0;
    if (status > 403 || status < 400) {
      if (status === 201 || status === 200) {
        var json = Core__Option.getExn(response_store.json, "[Login.json] Destructuring error");
        var token = Core__Option.getExn(json.token, "[Login.token] Destructuring error");
        var credentials_email = form_data.email;
        var credentials = {
          email: credentials_email,
          token: token
        };
        var credentials_stringified = Core__Option.getExn(JSON.stringify(credentials), undefined);
        Browser.store(Meta.schema.system.constants.storage_key, credentials_stringified);
        dialog.innerText = "Login realizado com sucesso";
        console.log(JSON.stringify(Browser.retrieve(Meta.schema.system.constants.storage_key)));
        return ;
      }
      exit = 1;
    } else {
      if (!(status === 402 || status === 401)) {
        dialog.innerText = "Requisição inválida. Os dados informados estão corretos?";
        return ;
      }
      exit = 1;
    }
    if (exit === 1) {
      console.log("Unexpected return status " + status.toString());
      return ;
    }
    
  }
  catch (raw_error$1){
    var error$1 = Caml_js_exceptions.internalToOCamlException(raw_error$1);
    console.log(error$1);
    dialog.innerText = "Erro ao processar resposta";
    return ;
  }
}

async function structure(param) {
  await populate_form();
  return Browser.submitListen(Browser.getElement("login_form", "Login.addSubmitListener"), login_handler);
}

export {
  populate_form ,
  login_handler ,
  structure ,
}
/* No side effect */
